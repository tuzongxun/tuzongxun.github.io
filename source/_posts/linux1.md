---
title: VMware虚拟机Linux系统NAT模式网络配置及虚拟机克隆要点
date: 2020-6-29 22:09:42
tags: linux
toc: true
categories: linux
---
VMware虚拟机及Linux系统，实际安装过多次，但一直都是网上搜一篇傻瓜式教程，然后几乎不假思索的装完。
无论是VMware本身，还是在VMware里安装虚拟机，还是在虚拟机里安装Linux系统，应该都是比较简单的。
但是个人很多次的安装，以及了解到的其他一些同事安装，都经常会卡在网络上，安装完之后翻来覆去就是连不上网，然后可能就再不断的搜索和尝试，实际还都是盲人摸象，再来一次的时候又是各种问题。
之前的安装，网络都是选的桥接模式，这一次也是根据一定的教程，选择了NAT模式，与之前不同的是，这次所掌握的内容可以保证以后的安装都不再受网络困扰。

<!--more-->

>网络配置本身，不论是windows，还是Linux，其实大的来说都分两步，第一步就是找到网卡配置的位置，第二步就是配置网络。

##  windows中网络配置
windows习惯于图形界面的操作，一般步骤是：
1. 电脑右下角网络图标位置，右键然后选择“打开网络和internet设置”；
2. 选择以太网或者其他具体网络类型；
3. 选择更改适配器选项；
4. 以上出现的界面中会有很多种网卡配置，如果选在的是以太网，这里就双击打开以太网那一项；
5. 点击属性，然后再双击“internet 协议配置4”，这里就是ipv4的配置。
6. 在ipv4配置界面，就可以选择是自动获取ip地址和dns地址，还是手动配置静态的ip以及dns这些。

上边前3部可以理解为找到网卡配置位置，后三步就可以理解为是对网卡的配置。对于windows系统来说，没太注意这个细节，似乎是默认的自动获取可以不用配置。

## VMware中Linux网络配置
Linux系统也有图形界面，但是对于我们这些用这个系统的大部分人来说，可能更习惯也更习惯命令行操作。
在命令行操作模式下，网卡配置大的来说依然是和windows一样分为找网卡配置位置和配置网络两个步骤。
### 网卡配置文件位置
lcentos 系统中网卡配置文件位置在/etc/sysconfig/network-scripts目录中，个人使用的话，直接就用ifcfg-eth0这个文件即可。
### 网络配置
刚安装好的Linux系统，打开上边的网卡配置，内容如下：
```
DEVICE=eth0
HWADDR=00:0C:29:A4:2A:31
TYPE=Ethernet
UUID=da6741e2-9b2c-464f-9a5b-cbe65402e21c
ONBOOT=no
NM_CONTROLLED=yes
BOOTPORTO=dhcp
```

以上各项含义如下：
```
DEVICE：网卡的名字
HWADDR：HWADDR HardWare Address 硬件地址 MAC地址
TYPE：网络类型 Ethernet以太网
UUID：唯一编号
ONBOOT：在开机或重启网卡的时候是否启动网卡
NM_CONTROLLED：是否受network程序管理
BOOTPROTO：网卡获取ip地址的方式，分为dhcp自动获取ip地址，none固定的ip地址，static固定的ip地址
```

对于上述配置，要改成NAT模式，先把ONBOOT的值改为yes，然后需要把ip获取方式改为静态，即static.
如果后边需要克隆当前虚拟机，最好是把HWADDR和UUID都删掉。这两个本身就是保证虚拟机网络的唯一性，如果不删，就导致克隆后的网卡和唯一编号重复，可能导致无法上网。

昨晚上述修改之后，既然是静态ip，就需要做静态ip相关的配置，要再加四项配置：
```
IPADDR：设置的静态IP
NETMASK：子网掩码
GATEWAY：网关
DNS：dns解析地址
```

上述四个配置，DNS比较好选，一般是`114.114.114.114`，这是国内第一个、全球第三个开放的DNS服务地址。
DNS可以配置多个，所以这里可以配成`DNS1=114.114.114.114`。

剩下的几个怎么配置就比较关键，要设置静态IP，就必须知道网段是什么，需要知道哪些IP是可以用的。
这时候可以借助VMware的功能来获取，如下图所示：

![net](/images/linux/net.png)

首先点击编号1处的编辑，就会弹出右侧2号界面，然后再3号位置选择以管理员身份更改设置，再接下来的弹出框点击确定后会出现如下界面：

![net2](/images/linux/net2.png)

上图中首先最上边需要选择NAT模式，然后就会看到有一个子网IP192.168.139.0，证明我们的网络实际处在这个网段，并且192.168.139.0是被用了的。
然后编号2处，就是我们需要的子网掩码，那么我们的配置就可以修改为`NETMASK=255.255.255.0`了。
接下来再点击编号3处"NAT设置"，会看到如下弹出界面：

![net3](/images/linux/net3.png)

上图标红的位置，其实也可以看到上边的子网ip和子网掩码，同时，我们还能找到需要的网关，那么配置又可以进一步完善`GATEWAY=192.168.139.2`，同时也表示又有一个当前网段的ip我们自己是不能用了。
到这里，看起来就可以配置静态的IPADDR了，实际上还有一个点小问题，如下图：

![net4](/images/linux/net4.png)

编号4的位置，会使实际物理机的网络和虚拟机网络连接起来，会在物理机上创建一个虚拟网卡，也就是VMnet8：

![net5](/images/linux/net5.png)

双击打开之后，点击详情会发现，里边有一个ip是`192.168.139.1`，代表的是主机虚拟网卡的ip，也就说明这个ip我们也不能用。
因此最终确认需要配置的IP网段是192.168.139，最后的IP不能用255、0、1、2，在这些数字之外选择一个小于255的IP之后，完整的网络配置就可以修改为：
```
DEVICE=eth0
HWADDR=00:0C:29:A4:2A:31
TYPE=Ethernet
UUID=da6741e2-9b2c-464f-9a5b-cbe65402e21c
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPORTO=static
DNS1=114.114.114.114
NETMASK=255.255.255.0
GATEWAY=192.168.139.2
IPADDR=192.168.139.99

```

以上配置保存后，执行网卡重启命令`service network restart`，虚拟机便可以成功上网了，可以用`ping www.baidu.com`进行验证。

以上便是VMware中Linux系统里NAT模式网络配置步骤以及技巧，相信有了这次的配置，后边再也不用为虚拟机上网问题发愁了，也希望能对其他同学有所帮助。

## VMware中虚拟机克隆
学习大数据技术，往往需要多个虚拟机节点，如果每一个都按普通的步骤安装，会很耗时间，所以更便捷的方法就是克隆已有的虚拟机。
克隆之前最好先把源虚拟机生成快照，然后再次基础上克隆。
克隆后的虚拟机，无论网卡、ip还是hostname都和原来的一模一样，这是有问题的，所以实际上克隆之后需要修改新的虚拟机系统配置。
由上边的网络配置只是可知，需要修改不通的IPADDR。如果在没有删除物理网卡和UUID的情况下，还需要修改这两项，最好就是删除。
除此之外，还要修改hostname，用过kafka的可能知道，这个hostname非常重要，这个配置在`/etc/sysconfig/network`文件中。
最后一个需要修改的地方，就还是和物理网卡有关，需要删除`/etc/udev/rules.d`目录下的70-persistent-net.rules文件，删除之后重启网卡的时候就会重新生成这个文件，并且不会和克隆的一样，也就可以避免这种网络问题。